{% extends "base.html" %}

{% block title %}Reset Password - SCMXpertLite{% endblock %}

{% block content %}
<div style="min-height: 80vh; display:flex; align-items:center; justify-content:center;">
    <div class="glass-card" style="width: 100%; max-width: 450px;">
        <h2 style="text-align:center; font-size: 1.8rem; margin-bottom: 0.5rem;">Reset Password</h2>
        <p style="text-align:center; color: var(--text-muted); margin-bottom: 2rem;">Secure Account Recovery</p>

        <!-- STEP 1: Request OTP -->
        <form id="step1Form">
            <div class="form-group">
                <input id="emailInput" type="email" class="form-input" placeholder=" " required />
                <label class="form-label">Registered Email</label>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;">
                SEND OTP CODE
            </button>
        </form>

        <!-- STEP 2: Verify OTP & Reset -->
        <form id="step2Form" style="display: none; animation: fadeInUp 0.5s ease;">
            <div style="background: rgba(0,210,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; color: var(--primary); font-size: 0.9rem;">
                OTP sent to <span id="displayEmail" style="font-weight: bold;"></span>
            </div>

            <div class="form-group">
                <input id="otpInput" type="text" class="form-input" placeholder=" " maxlength="6" required style="letter-spacing: 5px; text-align: center; font-size: 1.2rem;" />
                <label class="form-label">Enter 6-Digit OTP</label>
            </div>

            <div class="form-group">
                <input id="newPassInput" type="password" class="form-input" placeholder=" " minlength="8" required />
                <label class="form-label">New Password</label>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;">
                UPDATE PASSWORD
            </button>
        </form>
        
        <div id="msg" style="margin-top: 1rem; text-align: center; height: 20px;"></div>

        <p style="text-align: center; margin-top: 2rem; color: var(--text-muted);">
            <a href="/" style="color: white; text-decoration: none;"><i class="fa-solid fa-arrow-left"></i> Back to Login</a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const step1 = document.getElementById('step1Form');
    const step2 = document.getElementById('step2Form');
    const msg = document.getElementById('msg');
    let userEmail = "";

    // Handle Send OTP
    step1.addEventListener('submit', async (e) => {
        e.preventDefault();
        userEmail = document.getElementById('emailInput').value;
        msg.innerHTML = '<span style="color:var(--primary)"><i class="fa-solid fa-circle-notch fa-spin"></i> Sending OTP...</span>';

        try {
            const res = await postJSON('/api/v1/forgot-password', { email: userEmail }, false);
            if(res.ok) {
                // Switch UI
                step1.style.display = 'none';
                step2.style.display = 'block';
                document.getElementById('displayEmail').textContent = userEmail;
                msg.textContent = '';
                // Focus on OTP
                document.getElementById('otpInput').focus();
            } else {
                msg.innerHTML = '<span style="color:var(--accent)">Failed to send OTP.</span>';
            }
        } catch(err) { msg.textContent = 'Server Error'; }
    });

    // Handle Reset
    step2.addEventListener('submit', async (e) => {
        e.preventDefault();
        const otp = document.getElementById('otpInput').value;
        const pass = document.getElementById('newPassInput').value;
        
        msg.innerHTML = '<span style="color:var(--primary)"><i class="fa-solid fa-circle-notch fa-spin"></i> Updating...</span>';

        try {
            const res = await postJSON('/api/v1/reset-password', { 
                email: userEmail,
                otp: otp,
                new_password: pass 
            }, false);

            const json = await res.json();
            
            if(res.ok) {
                msg.innerHTML = '<span style="color:#00ff88">Password Changed! Redirecting...</span>';
                setTimeout(() => window.location.href = '/', 1500);
            } else {
                msg.innerHTML = `<span style="color:var(--accent)">${json.detail || 'Invalid OTP'}</span>`;
            }
        } catch(err) { msg.textContent = 'Server Error'; }
    });
</script>
{% endblock %}